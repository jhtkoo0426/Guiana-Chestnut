{% extends "base_pages/dashboard_base.html" %}
{% load static %}
{% load dashboard_filters %}
{% block styles %}
    <link rel="stylesheet" href="{% static 'css/base_pages/dashboard_base.css' %}">
    <link rel="stylesheet" href="{% static 'css/dashboard/search_results.css' %}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/4.6.0/echarts-en.min.js"></script>
    <script src="https://requirejs.org/docs/release/2.3.5/minified/require.js"></script>
{% endblock styles %}

{% block dashboard-title %}
    <div class="symbol-details">
        <img src="{{ sym_logo }}" alt="" class="symbol-logo">
        <div class="symbol-title">
            <h1>{{ sym_name }} ({{ symbol }})</h1>
            <p>{{ sym_exchange }} ({{ sym_obj.symbol_exchange_code.exchange_code }}). Currency in {{ sym_currency }}</p>
        </div>
    </div>
{% endblock dashboard-title %}

{% block dashboard-content %}
    <div class="symbol-price">
        <span class="last-close">{{ sym_last_close }}</span>
        <span class="last-close-date">(Last updated: {{ sym_last_date }})</span>
    </div>
    <div class="symbol-core-data-container">
        <div class="symbol-candlesticks" id="candlesticks-chart" style="width: 100%; height: 500px;"></div>
        <div class="symbol-data">
            <div class="symbol-data-column summary">
                <p>Summary</p><br>
                {% for metric, value in financials.items %}
                    <div class="symbol-data-item">
                        <span>{{ metric }}</span>
                        <strong><span>{{ value }}</span></strong>
                    </div>
                    <hr>
                {% endfor %}
            </div>
        </div>
    </div>
    <div class="symbol-news">
        <p>Latest News</p><br>
        {% for news in weekly_news %}
            <div class="news-item">
                <img class="news-image" src="{{ news|get_item:'image'}}"></img>
                <div>
                    <p>{{ news|get_item:'source' }} | {{ news|get_item:'upload_timedelta'}}</p>
                    <a class="news-headline" href="{{ news|get_item:'url' }}" target="_blank">
                        {{ news|get_item:'headline' }}
                    </a>
                </div>
            </div>
        {% endfor %}
    </div>
    
{% endblock dashboard-content %}

{% block javascript %}
    <script>
        // Initialize candlesticks chart.
        var chartDom = document.getElementById('candlesticks-chart');
        var myChart = echarts.init(chartDom);

        // Add responsiveness to candlesticks chart.
        window.onresize = function() {
            myChart.resize();
        }

        var candlesticks = {{candlesticks|safe}};
        
        plotSymbolCandlesticks(candlesticks, JSON.parse(JSON.stringify("{{ sym|safe }}")));

        function plotSymbolCandlesticks(candlesticks, sym) {

            // Colors for candlesticks;
            const upColor = '#26A69A';
            const upBorderColor = '#26A69A';
            const downColor = '#FF7075';
            const downBorderColor = '#FF7075';

            // Options for candlesticks chart;
            var option = {
                xAxis: {
                data: candlesticks['t'],
                min: 'dataMin',
                max: 'dataMax',
                axisLabel: {
                    color: '#6A6D78',
                },
                axisLine: {
                    lineStyle: {
                        color: '#E0E3EB',
                    }
                }
                },
                yAxis: {
                    scale: true,
                    axisLabel: {
                        color: '#6A6D78',
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#E0E3EB',
                        }
                    },
                    splitLine: {
                        lineStyle: {
                            color: '#E0E3EB',
                        }
                    }
                },
                grid: {
                    borderColor: '#E0E3EB',
                    left: 30,
                    top: 20,
                    right: 0,
                    bottom: 50
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross',
                    }
                },
                dataZoom: [
                    {
                        type: 'inside',
                        start: 99,
                        end: 100
                    },
                    {
                        show: true,
                        type: 'slider',
                        start: 99,
                        end: 100,
                        bottom: 0,
                        borderColor: '#E0E3EB',
                        fillerColor: 'rgba(106, 109, 120, 0.6)',
                        handleStyle: {
                            borderColor: '#E0E3EB',
                            color: '#6A6D78'
                        },
                        dataBackground: {
                            areaStyle: {
                                color: '#6A6D78',
                            },
                        },
                    }
                ],
                series: [
                    {
                        name: sym,
                        type: 'candlestick',
                        data: candlesticks['data'],
                        itemStyle: {
                        color: upColor,
                        color0: downColor,
                        borderColor: upBorderColor,
                        borderColor0: downBorderColor
                        },
                    }
                ],
            };

            myChart.setOption(option);
        }
    </script>

    <script>
        const api_key = "{{api_key}}";
        const symbol = "{{symbol}}";
        const last_price_display = document.querySelector(".last-close");
        let last_price = null;

        const socket = new WebSocket('wss://ws.finnhub.io?token=' + api_key);

        // Connection opened -> Subscribe
        socket.addEventListener('open', function (event) {
            // socket.send(JSON.stringify({'type':'subscribe', 'symbol': 'TSLA'}))
            // socket.send(JSON.stringify({'type':'subscribe', 'symbol': 'AMD'}))
            socket.send(JSON.stringify({'type':'subscribe', 'symbol': symbol}))
        });

        socket.onmessage = (event) => {
            var socket_data = JSON.parse(event.data);
            last_price = socket_data['data'][socket_data['data'].length - 1]['p'];
        }

        
        // Listen for messages
        setInterval(() => {
            last_price_display.innerHTML = last_price;
        }, 5000)

        // Unsubscribe
        window.onbeforeunload = function(symbol) {
            socket.send(JSON.stringify({'type':'unsubscribe','symbol': symbol}))
        } 
    </script>
{% endblock %}